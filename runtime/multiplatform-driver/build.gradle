apply plugin: 'maven-publish'
apply plugin: 'kotlin-platform-common'
apply plugin: 'com.jfrog.bintray'

archivesBaseName = 'sqldelight-multiplatform-driver'

dependencies {
    implementation deps.kotlin.stdlibCommon
    implementation project(':runtime:sqldelight-runtime')
    implementation "co.touchlab.knarch:knarch-common:0.1"
}

group = 'com.squareup.sqldelight'
version = "0.1"

ext.bintrayGitUrl = 'https://github.com/touchlab/sqldelight'

apply from: "https://raw.githubusercontent.com/doppllib/gradlescripts/master/kotlinpublish.gradle"
apply from: "https://raw.githubusercontent.com/doppllib/gradlescripts/master/bintray.gradle"

repositories {
    mavenCentral()
    google()
    jcenter()
    maven { url j2objcMavenDeploy }
}

buildscript {
    repositories {
        mavenCentral()
        maven {
            url  "https://dl.bintray.com/jetbrains/kotlin-native-dependencies"
        }
    }

    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-native-gradle-plugin:${versions.konan}"
        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.7.3'
    }
}

apply plugin: 'konan'

konan.targets = ['iphone', 'iphone_sim', 'macos_x64']

konanArtifacts {
    library("sqldelight-driver"){
        srcDir 'src/main/kotlin'
        srcDir 'src/main/kotlinios'

        //This should work but something is wrong with either the plugin or the config.
        //Hard coding the libs and repos will fail when building. Must comment out
        //this project in settings.gradle, build, then uncomment and build. Ugh.
        /*libraries {
            artifact project(':runtime:sqldelight-runtime'), 'sqldelight'
        }*/

        target('iphone') {
            libraries {
                useRepos '../../lib/knarch/kotlin/ios_arm64', '../sqldelight-runtime/build/konan/libs/ios_arm64'
                klibs 'knarch', 'sqldelight'
            }
        }
        target('iphone_sim') {
            libraries {
                useRepos '../../lib/knarch/kotlin/ios_x64', '../sqldelight-runtime/build/konan/libs/ios_x64'
                klibs 'knarch', 'sqldelight'
            }
        }
        target('macos_x64') {
            libraries {
                useRepos '../../lib/knarch/kotlin/macos_x64', '../sqldelight-runtime/build/konan/libs/macos_x64'
                klibs 'knarch', 'sqldelight'
            }
        }
        enableMultiplatform true
    }
}